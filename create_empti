import bpy
import re


# ========================
# ОБЩИЕ УТИЛИТЫ
# ========================

def select_bone_in_pose_mode(armature, bone_name):
    for pose_bone in armature.pose.bones:
        pose_bone.select = False
    armature.data.bones.active = None

    if bone_name not in armature.pose.bones:
        return False

    armature.pose.bones[bone_name].select = True
    armature.data.bones.active = armature.data.bones[bone_name]
    return True


# ========================
# РЕЖИМ 1: КОСТИ → СОЗДАТЬ EMPTY + КОНСТРЕЙНТЫ
# ========================

def create_reparent_for_bone(obj, bone):
    target_name = f"{obj.name}_{bone.name}_reParent"
    scene = bpy.context.scene
    start = scene.frame_start
    end = scene.frame_end

    # --- Создаём Empty
    empty = bpy.data.objects.new(target_name, None)
    bpy.context.collection.objects.link(empty)

    empty.location = (0, 0, 0)
    empty.rotation_euler = (0, 0, 0)
    empty.rotation_mode = bone.rotation_mode

    # --- Child Of к кости
    childof = empty.constraints.new(type='CHILD_OF')
    childof.name = "reParent_CHILD_OF"
    childof.target = obj
    childof.subtarget = bone.name

    bpy.context.view_layer.update()
    childof.inverse_matrix.identity()

    return empty


def run_create_reparent(obj, selected_bones):
    scene = bpy.context.scene
    start = scene.frame_start
    end = scene.frame_end

    empties = []

    for bone in selected_bones:
        empty = create_reparent_for_bone(obj, bone)
        empties.append((bone, empty))
        print(f"  Создан Empty: {empty.name}")

    # --- Переходим в Object Mode для bake
    bpy.ops.object.mode_set(mode='OBJECT')

    for o in bpy.context.selected_objects:
        o.select_set(False)

    # --- Bake всех empty за один раз
    for bone, empty in empties:
        empty.select_set(True)

    bpy.context.view_layer.objects.active = empties[0][1]

    bpy.ops.nla.bake(
        frame_start=start,
        frame_end=end,
        only_selected=True,
        visual_keying=True,
        clear_constraints=False,
        use_current_action=False,
        bake_types={'OBJECT'}
    )

    # --- Удаляем Child Of у всех empty
    for bone, empty in empties:
        for c in list(empty.constraints):
            empty.constraints.remove(c)

    # --- Возвращаемся к арматуре, входим в Pose Mode
    bpy.context.view_layer.objects.active = obj
    obj.select_set(True)
    bpy.ops.object.mode_set(mode='POSE')

    # --- Добавляем констрейнты к костям
    for bone, empty in empties:
        copy_loc = bone.constraints.new(type='COPY_LOCATION')
        copy_loc.name = "reParent_COPY_LOCATION"
        copy_loc.target = empty
        copy_loc.owner_space = 'WORLD'
        copy_loc.target_space = 'WORLD'

        copy_rot = bone.constraints.new(type='COPY_ROTATION')
        copy_rot.name = "reParent_COPY_ROTATION"
        copy_rot.target = empty
        copy_rot.owner_space = 'WORLD'
        copy_rot.target_space = 'WORLD'

        print(f"  Констрейнты добавлены к кости: {bone.name}")

    # --- Финальное выделение всех empty
    bpy.ops.object.mode_set(mode='OBJECT')
    for o in bpy.context.selected_objects:
        o.select_set(False)

    for bone, empty in empties:
        empty.select_set(True)

    bpy.context.view_layer.objects.active = empties[0][1]

    print(f"✓ Готово! Создано Empty: {len(empties)}")


# ========================
# РЕЖИМ 2: EMPTY → BAKE КОСТЕЙ + УДАЛИТЬ EMPTY
# ========================

def bake_bones(armature, bone_names):
    scene = bpy.context.scene
    print(f"Bake: frames {scene.frame_start} - {scene.frame_end}, костей: {len(bone_names)}")

    bpy.ops.nla.bake(
        frame_start=scene.frame_start,
        frame_end=scene.frame_end,
        only_selected=True,
        visual_keying=True,
        clear_constraints=False,
        clear_parents=False,
        use_current_action=True,
        clean_curves=False,
        bake_types={'POSE'}
    )

    print(f"✓ Bake завершён для {len(bone_names)} костей")


def remove_reparent_constraints(armature, bone_name):
    if bone_name not in armature.pose.bones:
        print(f"  ✗ Кость {bone_name} не найдена")
        return

    pose_bone = armature.pose.bones[bone_name]
    to_remove = [c for c in pose_bone.constraints if 'reParent' in c.name]

    if not to_remove:
        print(f"  ✗ Констрейны 'reParent' не найдены у кости {bone_name}")
        return

    for constraint in to_remove:
        pose_bone.constraints.remove(constraint)

    print(f"  ✓ Удалено констрейнов у {bone_name}: {len(to_remove)}")


def run_bake_reparent(empty_objects):
    # --- Парсим имена, находим арматуры и кости
    tasks = []  # (empty, armature, bone_name)

    for empty in empty_objects:
        match = re.match(r'(.+)_(.+)_reParent', empty.name)
        if not match:
            print(f"  ✗ Неверный формат имени: {empty.name}, пропускаем")
            continue

        rig_name, bone_name = match.groups()
        armature = bpy.data.objects.get(rig_name)

        if not armature or armature.type != 'ARMATURE':
            print(f"  ✗ Арматура '{rig_name}' не найдена, пропускаем")
            continue

        tasks.append((empty, armature, bone_name))

    if not tasks:
        print("✗ Нет валидных задач для обработки")
        return

    # --- Группируем задачи по арматуре
    by_armature = {}
    for empty, armature, bone_name in tasks:
        key = armature.name
        if key not in by_armature:
            by_armature[key] = {'armature': armature, 'items': []}
        by_armature[key]['items'].append((empty, bone_name))

    # --- Снимаем выделение с пустышек
    for o in bpy.context.selected_objects:
        o.select_set(False)

    # --- Обрабатываем каждую арматуру
    for rig_name, data in by_armature.items():
        armature = data['armature']
        items = data['items']
        bone_names = [bone_name for _, bone_name in items]

        print(f"\nОбработка арматуры: {rig_name}, костей: {len(items)}")

        # Входим в Pose Mode и выделяем все нужные кости
        bpy.context.view_layer.objects.active = armature
        armature.select_set(True)
        bpy.ops.object.mode_set(mode='POSE')

        # Снимаем выделение со всех костей
        for pb in armature.pose.bones:
            pb.select = False
        armature.data.bones.active = None

        # Выделяем нужные кости
        found_bones = []
        for bone_name in bone_names:
            if bone_name in armature.pose.bones:
                armature.pose.bones[bone_name].select = True
                armature.data.bones.active = armature.data.bones[bone_name]
                found_bones.append(bone_name)
                print(f"  ✓ Кость выделена: {bone_name}")
            else:
                print(f"  ✗ Кость не найдена: {bone_name}")

        if not found_bones:
            bpy.ops.object.mode_set(mode='OBJECT')
            continue

        # Bake всех костей этой арматуры за один раз
        bake_bones(armature, found_bones)

        # Удаляем констрейнты
        for bone_name in found_bones:
            remove_reparent_constraints(armature, bone_name)

        # Выходим в Object Mode
        bpy.ops.object.mode_set(mode='OBJECT')

    # --- Удаляем все empty
    bpy.ops.object.select_all(action='DESELECT')
    for empty, armature, bone_name in tasks:
        empty.select_set(True)

    count = len([t for t in tasks])
    bpy.ops.object.delete()
    print(f"\n✓ Удалено пустышек: {count}")

    # --- Возвращаемся к последней арматуре, выделяем кости
    last_armature = tasks[-1][1]
    last_bone = tasks[-1][2]

    bpy.context.view_layer.objects.active = last_armature
    last_armature.select_set(True)
    bpy.ops.object.mode_set(mode='POSE')

    for pb in last_armature.pose.bones:
        pb.select = False

    for empty, armature, bone_name in tasks:
        if armature == last_armature and bone_name in armature.pose.bones:
            armature.pose.bones[bone_name].select = True
            armature.data.bones.active = armature.data.bones[bone_name]

    print("✓ Все операции завершены")


# ========================
# ТОЧКА ВХОДА
# ========================

def main():
    active = bpy.context.active_object

    if not active:
        print("✗ Нет активного объекта")
        return

    # Режим 2: выбраны пустышки с суффиксом _reParent
    if active.type == 'EMPTY' and active.name.endswith('_reParent'):
        selected_empties = [
            o for o in bpy.context.selected_objects
            if o.type == 'EMPTY' and o.name.endswith('_reParent')
        ]
        print(f"→ Режим: Bake костей и удаление Empty ({len(selected_empties)} шт.)")
        run_bake_reparent(selected_empties)

    # Режим 1: кости в Pose Mode
    elif bpy.context.mode == 'POSE':
        selected_bones = bpy.context.selected_pose_bones
        if not selected_bones:
            print("✗ Нет выделенных костей в Pose Mode")
            return
        obj = bpy.context.active_object
        print(f"→ Режим: Создание Empty и констрейнтов ({len(selected_bones)} костей)")
        run_create_reparent(obj, selected_bones)

    else:
        print("✗ Выделите кости в Pose Mode или пустышки с суффиксом '_reParent'")


main()
